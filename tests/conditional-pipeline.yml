parameters:
- name: environment
  type: string
  default: dev
  values:
  - dev
  - staging
  - prod
- name: runTests
  type: boolean
  default: true
- name: environments
  type: object
  default: [ dev, staging, prod ]


trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: Release
  ${{ if eq(parameters.environment, 'prod') }}:
    deploymentStrategy: blue-green
  ${{ else }}:
    deploymentStrategy: rolling


stages:
- stage: Build
  displayName: Build Stage

  jobs:
  - job: BuildJob
    displayName: Build Application

    steps:
    - task: DotNetCoreCLI@2
      displayName: Restore packages
      inputs:
        command: restore
        projects: '**/*.csproj'

    - task: DotNetCoreCLI@2
      displayName: Build application
      inputs:
        command: build
        projects: '**/*.csproj'
        arguments: --configuration ${{ parameters.environment }}

- ${{ if eq(parameters.runTests, true) }}:
  - stage: Test
    displayName: Test Stage
    dependsOn: Build

    jobs:
    - job: TestJob
      displayName: Run Tests

      steps:
      - task: DotNetCoreCLI@2
        displayName: Run unit tests
        inputs:
          command: test
          projects: '**/*Tests.csproj'
          arguments: --configuration $(buildConfiguration) --collect:"XPlat Code Coverage"

- ${{ if ne(parameters.environment, 'dev') }}:
  - stage: Deploy
    displayName: Deploy to ${{ parameters.environment }}
    dependsOn:
    - Build

    - ${{ if eq(parameters.runTests, true) }}:
      - Test

    jobs:
    - deployment: DeploymentJob
      displayName: Deploy Application
      environment: ${{ parameters.environment }}
      strategy:
        runOnce:
          deploy:

            steps:
            - task: AzureWebApp@1
              displayName: Deploy to Azure Web App
              inputs:
                azureSubscription: Azure-Subscription
                appType: webAppLinux
                appName: myapp-${{ parameters.environment }}
                package: $(Pipeline.Workspace)/drop/*.zip
# Loop through multiple environments for notifications

- ${{ each env in parameters.environments }}:
  - stage: Notify_${{ env }}
    displayName: Notify ${{ env }} team
    condition: and(succeeded(), eq('${{ parameters.environment }}', '${{ env }}'))

    jobs:
    - job: NotificationJob
      displayName: Send notification for ${{ env }}

      steps:
      - task: PowerShell@2
        displayName: Send Teams notification
        inputs:
          targetType: inline
          script: |
            Write-Host "Sending notification for environment: ${{ env }}"

            # Add Teams webhook notification logic here
