name: Comprehensive Expression Functions Test
parameters:
- name: environment
  type: string
  default: prod
- name: version
  type: string
  default: 1.2.3
- name: enableTests
  type: boolean
  default: true
- name: items
  type: object
  default:
  - item1
  - item2
  - item3
variables:
  boolValue: ${{ true }}
  numberValue: ${{ 42 }}
  isEqual: ${{ eq(parameters.environment, 'prod') }}
  notEqual: ${{ ne(parameters.version, '0.0.0') }}
  greaterThan: ${{ gt(5, 3) }}
  andResult: ${{ and(true, true, true) }}
  orResult: ${{ or(false, true, false) }}
  notResult: ${{ not(false) }}
  xorResult: ${{ xor(true, false) }}
  lowerCase: ${{ lower('HELLO') }}
  upperCase: ${{ upper('world') }}
  trimmed: ${{ trim('  spaces  ') }}
  conditionalValue: ${{ iif(eq(parameters.environment, 'prod'), 'production', 'development') }}
stages:
- stage: Build
  # Using and() with succeeded()
  condition: ${{ and(succeeded(), eq(parameters.enableTests, true)) }}
  jobs:
  - job: BuildJob
    steps:
    - script: echo "Building..."
    - script: echo "Environment is prod"
    - script: echo ${{ replace(parameters.version, '.', '_') }}
    # Conditional step using eq()
    - ${{ if eq(parameters.environment, 'prod') }}:
      - script: echo "Production build"
    - ${{ else }}:
      - script: echo "Non-production build"
    # Using each with string functions
    - ${{ each item in parameters.items }}:
      - script: echo ${{ upper(item) }}

- stage: Test
  condition: ${{ or(eq(parameters.enableTests, true), contains(parameters.environment, 'test')) }}
  dependsOn: Build
  jobs:
  - job: TestJob
    condition: ${{ not(eq(parameters.environment, 'skip')) }}
    steps:
    - script: echo "Running tests"
    # Using startsWith() and endsWith()
    - ${{ if startsWith(parameters.environment, 'prod') }}:
      - script: echo "Production tests"
    - ${{ if endsWith(parameters.version, '0') }}:
      - script: echo "Version ends with 0"

- stage: Deploy
  condition: ${{ and(succeeded(), ne(parameters.environment, 'skip'), or(eq(parameters.environment, 'prod'), eq(parameters.environment, 'staging'))) }}
  dependsOn: Test
  jobs:
  - job: DeployJob
    steps:
    - script: echo "Deploying..."
    - script: echo prod
    - script: echo "Valid environment"
      condition: true
    - script: echo "Not a test environment"
      condition: true
    - script: echo "Always runs"
      condition: true
    - script: echo "Runs if succeeded"
      condition: true
