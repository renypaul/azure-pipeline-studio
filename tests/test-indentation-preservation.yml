name: Test Indentation-Specific Value Preservation
# This test ensures that literal values are not replaced with template expressions
# from different indentation levels during formatting

parameters:
- name: pythonVersion
  type: string
  default: '3.10'
- name: nodeVersion
  type: string
  default: 18.x

stages:
- stage: Build

  jobs:
  - job: SetupEnvironment
    steps:
    - template: /templates/python-setup.yaml
      parameters:
        # This literal version should NOT be replaced with $(version) below
        version: '3.10'
        displayName: Setup Python

    - template: /templates/node-setup.yaml
      parameters:
        # This literal should stay as-is
        version: 18.x
        registry: https://registry.npmjs.org
    - script: |
        echo "Python version: 3.10"
        echo "Node version: 18.x"
      displayName: Display versions

- stage: Deploy
  dependsOn: Build

  jobs:
  - job: DeployService
    strategy:
      matrix:
        service1:
          serviceName: $(serviceName)
          # These template expressions should be preserved
          version: $(version)
          ecrRepo: $(ecrRepo)
          tag: $(tag)
        service2:
          serviceName: api-service
          # Literal values here should not be replaced
          version: 2.1.0
          ecrRepo: my-registry/api
          tag: latest
    variables:
      # Template expressions in variables section
      serviceName: $(serviceName)
      version: $(version)
      ecrRepo: $(ecrRepo)
      condition: ${{ parameters.condition }}
      runtimeCheck: $[eq(variables.deployEnvironment, 'production')]
    steps:
    - script: echo "Deploying $(serviceName) version $(version)"
      displayName: Deploy Service

- stage: Integration

  jobs:
  - job: RunTests
    steps:
    - task: PythonScript@0
      inputs:
        # Nested literal that looks similar to above but at different indentation
        scriptSource: inline
        script: |
          import sys
          print(f"Python {sys.version}")
        pythonVersion: '3.10'
    - task: NodeTool@0
      inputs:
        # Another nested literal
        versionSpec: 18.x
        checkLatest: false
    - script: |
        # Test with expressions
        VERSION=$(version)
        echo "Testing version: $VERSION"
      condition: ${{ ne(parameters.skipTests, true) }}
      displayName: Test with version variable

# Edge case: Same key at multiple indentation levels
- stage: ComplexNesting

  jobs:
  - job: NestedJob
    steps:
    - template: /templates/complex.yaml
      parameters:
        config:
          # 14-space indentation
          version: 1.0.0
          settings:
            # 16-space indentation  
            version: 2.0.0
            nested:
              # 18-space indentation
              version: ${{ parameters.configVersion }}
        deployment:
          # Back to 12-space indentation
          version: $(deploymentVersion)
