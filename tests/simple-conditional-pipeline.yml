parameters:
- name: environment
  type: string
  default: dev
  values: [dev, staging, prod]
- name: runTests
  type: boolean
  default: true
- name: deployRegions
  type: object
  default: [eastus, westus, centralus]


variables:
  buildConfiguration: Release
  ${{ if eq(parameters.environment, 'prod') }}:
    securityLevel: high
    deploymentSlots: 2
  ${{ else }}:
    securityLevel: medium
    deploymentSlots: 1
stages:
- stage: Build
  displayName: Build Application
  jobs:
  - job: BuildJob
    steps:
    - task: DotNetCoreCLI@2
      inputs:
        command: build
        configuration: $(buildConfiguration)

- ${{ if eq(parameters.runTests, true) }}:
  - stage: Test
    displayName: Test Application
    dependsOn: Build
    jobs:
    - job: TestJob
      steps:
      - task: DotNetCoreCLI@2
        inputs:
          command: test
          configuration: $(buildConfiguration)
# Deploy to multiple regions

- ${{ each region in parameters.deployRegions }}:
  - stage: Deploy_${{ region }}
    displayName: Deploy to ${{ region }}
    dependsOn:
    - Build
    - ${{ if eq(parameters.runTests, true) }}:
      - Test
    jobs:
    - deployment: DeployToRegion
      displayName: Deploy to ${{ region }}
      environment: ${{ parameters.environment }}-${{ region }}
      strategy:
        runOnce:
          deploy:
            steps:
            - task: AzureWebApp@1
              inputs:
                appName: myapp-${{ parameters.environment }}-${{ region }}
                resourceGroupName: rg-${{ parameters.environment }}
