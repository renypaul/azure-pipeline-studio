name: Recursive Format Cross-File Template Expression Test
# This test simulates the actual bug scenario where recursive formatting
# across multiple files could cause literal values to be replaced with
# template expressions from other files

parameters:
- name: serviceMatrix
  type: object
  default:
  - name: api
    version: '3.10'
    repo: api-service
  - name: worker
    version: '3.11'
    repo: worker-service

variables:
  # Global template expressions that should not leak into parameters
  pythonVersion: $(pythonVersion)
  nodeVersion: $(nodeVersion)
  deployVersion: $(Build.BuildNumber)

stages:
- stage: BuildServices

  jobs:
  - ${{ each service in parameters.serviceMatrix }}:
    - job: Build_${{ service.name }}
      variables:
        serviceName: ${{ service.name }}
        # Template expressions specific to this job
        version: $(version)
        tag: $(tag)
      steps:
      - template: /steps/build-python-service.yaml
        parameters:
          # Literal Python version for this specific service
          # Should NOT be replaced with $(version) from variables above
          pythonVersion: ${{ service.version }}
          serviceName: ${{ service.name }}
          repository: ${{ service.repo }}
      - script: |
          echo "Building ${{ service.name }}"
          echo "Python version: ${{ service.version }}"
        displayName: Build ${{ service.name }}

- stage: DeployServices
  dependsOn: BuildServices

  jobs:
  - job: DeployMatrix
    strategy:
      matrix:
        production:
          environment: prod
          # Runtime expressions in matrix
          version: $(prodVersion)
          region: $(prodRegion)
        staging:
          environment: stage
          # Different expressions per matrix entry
          version: $(stageVersion)
          region: $(stageRegion)
    variables:
      # Job-level template expressions
      serviceVersion: $(version)
      deploymentTag: $(tag)
      buildNumber: $(Build.BuildNumber)
    steps:
    - template: /steps/deploy-service.yaml
      parameters:
        # Compile-time expression
        environment: ${{ parameters.environment }}
        # Runtime expressions from variables
        version: $(serviceVersion)
        tag: $(deploymentTag)
        # Literal values that should not be touched
        timeout: 30
        retries: 3
        pythonVersion: '3.10'

- stage: Verification

  jobs:
  - job: VerifyDeployment
    steps:
    - script: |
        # Verify all services are deployed
        VERSION=$(Build.BuildNumber)
        echo "Verifying build $VERSION"
      displayName: Verify Version
    - task: PythonScript@0
      inputs:
        scriptSource: inline
        script: |
          import os
          version = os.getenv('VERSION', '3.10')
          print(f"Python {version}")
        # This literal should remain unchanged
        pythonInterpreter: '3.10'

    - template: /steps/health-check.yaml
      parameters:
        services:
        # Each service has its own version
        - name: api
          version: 1.2.3
          health: $(apiHealth)
        - name: worker
          version: 2.1.0
          health: $(workerHealth)
        # Global template expressions
        environment: ${{ parameters.deployEnvironment }}
        condition: ${{ parameters.healthCheckEnabled }}
