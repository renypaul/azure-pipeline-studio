parameters:
- name: deployEnvironments
  type: object
  default:
  - name: dev
    region: eastus
    runTests: true
  - name: staging
    region: westus
    runTests: true
  - name: prod
    region: centralus
    runTests: false
- name: buildMode
  type: string
  default: release
  values: [debug, release]


variables:
  solution: '**/*.sln'
  buildPlatform: Any CPU
  ${{ if eq(parameters.buildMode, 'debug') }}:
    buildConfiguration: Debug
    enableCodeCoverage: true
  ${{ else }}:
    buildConfiguration: Release
    enableCodeCoverage: false
stages:
- stage: BuildAndTest
  displayName: Build and Test Application
  jobs:
  - job: Build
    displayName: Build ${{ parameters.buildMode }} configuration
    steps:
    - task: NuGetToolInstaller@1
    - task: NuGetCommand@2
      inputs:
        restoreSolution: $(solution)
    - task: VSBuild@1
      inputs:
        solution: $(solution)
        platform: $(buildPlatform)
        configuration: $(buildConfiguration)
    - ${{ if eq(parameters.buildMode, 'debug') }}:
      - task: VSTest@2
        displayName: Run Unit Tests with Coverage
        inputs:
          platform: $(buildPlatform)
          configuration: $(buildConfiguration)
          codeCoverageEnabled: true
    - ${{ else }}:
      - task: VSTest@2
        displayName: Run Unit Tests
        inputs:
          platform: $(buildPlatform)
          configuration: $(buildConfiguration)

# Deploy to each environment
- ${{ each env in parameters.deployEnvironments }}:
  - stage: Deploy_${{ env.name }}
    displayName: Deploy to ${{ env.name }} (${{ env.region }})
    dependsOn: BuildAndTest
    condition: succeeded()
    variables:
      environmentName: ${{ env.name }}
      deploymentRegion: ${{ env.region }}
    jobs:
    - deployment: DeployApp
      displayName: Deploy to ${{ env.name }}
      environment: ${{ env.name }}
      strategy:
        runOnce:
          deploy:
            steps:
            - task: AzureRmWebAppDeployment@4
              displayName: Deploy Azure App Service
              inputs:
                ConnectionType: AzureRM
                WebAppName: myapp-${{ env.name }}
                deployToSlotOrASE: true
                ResourceGroupName: rg-${{ env.name }}
                SlotName: staging
    # Run tests if enabled for this environment  
    - ${{ if eq(env.runTests, true) }}:
      - job: PostDeploymentTests
        displayName: Post-deployment tests for ${{ env.name }}
        dependsOn: DeployApp
        steps:
        - task: PowerShell@2
          displayName: Run smoke tests
          inputs:
            targetType: inline
            script: |
              Write-Host "Running smoke tests for ${{ env.name }} in ${{ env.region }}"
              # Add smoke test commands here
              $endpoint = "https://myapp-${{ env.name }}.azurewebsites.net/health"
              $response = Invoke-WebRequest -Uri $endpoint -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "✅ Health check passed for ${{ env.name }}"
              } else {
                Write-Error "❌ Health check failed for ${{ env.name }}"
                exit 1
              }
# Final notification stage
- stage: Notifications
  displayName: Send Notifications
  dependsOn:
  - ${{ each env in parameters.deployEnvironments }}:
    - Deploy_${{ env.name }}
  condition: always()
  jobs:
  - job: SendNotifications
    displayName: Send deployment notifications
    steps:
    - task: PowerShell@2
      displayName: Send Teams notification
      inputs:
        targetType: inline
        script: |
          Write-Host "Deployment completed for all environments:"
          ${{ each env in parameters.deployEnvironments }}:
          Write-Host "- ${{ env.name }} (${{ env.region }}): $(Agent.JobStatus)"
