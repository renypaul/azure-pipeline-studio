name: Complex Azure Pipeline

trigger:
  branches:
    include: [ main, develop ]
    exclude: [ feature/*, bugfix/* ]
  tags:
    include: [ v*, release-* ]
  paths:
    include: [ src/**, tests/** ]
    exclude: [ docs/**, '*.md' ]

parameters:
- name: environment
  displayName: Target Environment
  type: string
  default: dev
  values: [ dev, staging, prod ]
- name: runTests
  displayName: Run Tests
  type: boolean
  default: true

variables:
- group: global-variables
- group: $(environment)-variables
- name: solution
  value: '**/*.sln'
- name: buildPlatform
  value: Any CPU
- name: buildConfiguration
  value: Release
- ${{ if eq(parameters.environment, 'prod') }}:
  - name: deploymentSlot
    value: production
- ${{ else }}:
  - name: deploymentSlot
    value: staging

resources:
  repositories:
  - repository: templates
    type: git
    name: shared/templates
    ref: refs/heads/main
  - repository: external
    type: github
    endpoint: github-connection
    name: microsoft/azure-pipelines-tasks

extends:
  template: templates/base-pipeline.yml@templates
  parameters:
    environment: ${{ parameters.environment }}
    stages:
    - stage: Build
      displayName: Build and Test
      condition: succeeded()
      variables:
        artifactName: $(Build.Repository.Name)-$(Build.BuildId)

      jobs:
      - job: BuildAndTest
        displayName: Build and Test Application
        pool:
          vmImage: ubuntu-latest
        strategy:
          matrix:
            Node16:
              nodeVersion: 16.x
            Node18:
              nodeVersion: 18.x
            Node20:
              nodeVersion: 20.x

        steps:
        - checkout: self
          fetchDepth: 0
          clean: true

        - checkout: templates
          path: s/templates

        - task: NodeTool@0
          displayName: Install Node.js $(nodeVersion)
          inputs:
            versionSpec: $(nodeVersion)

        - script: |
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Environment: ${{ parameters.environment }}"
            echo "Run tests: ${{ parameters.runTests }}"
            npm ci
            npm run build
          displayName: Install and Build

        - ${{ if eq(parameters.runTests, true) }}:
          - script: |
              npm run test:unit
              npm run test:integration
              npm run test:e2e
            displayName: Run All Tests
            continueOnError: ${{ eq(parameters.environment, 'dev') }}

        - task: PublishTestResults@2
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: JUnit
            testResultsFiles: '**/test-results.xml'
            mergeTestResults: true

        - task: PublishCodeCoverageResults@1
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: '**/coverage/cobertura-coverage.xml'

        - publish: $(System.DefaultWorkingDirectory)/dist
          artifact: $(artifactName)
          condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

    - ${{ if ne(parameters.environment, 'dev') }}:
      - stage: Deploy
        displayName: Deploy to ${{ parameters.environment }}
        dependsOn: Build
        condition: succeeded()

        jobs:
        - deployment: DeployToEnvironment
          displayName: Deploy Application
          environment: ${{ parameters.environment }}
          pool:
            vmImage: ubuntu-latest
          strategy:
            runOnce:
              deploy:

                steps:
                - download: current
                  artifact: $(artifactName)

                - task: AzureWebApp@1
                  displayName: Deploy to Azure Web App
                  inputs:
                    azureSubscription: $(serviceConnection)
                    appType: webAppLinux
                    appName: $(webAppName)
                    package: $(Pipeline.Workspace)/$(artifactName)
                    deploymentMethod: zipDeploy
                    slotName: $(deploymentSlot)
